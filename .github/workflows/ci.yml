name: CI

on:
  push:
    branches: ["master", "main"]
  pull_request:
  workflow_dispatch:

jobs:
  test-and-bench-gate:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: "0.15.2"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install nltk

      - name: Install JS deps
        run: bun install --frozen-lockfile

      - name: Import official NLTK fixtures
        run: bun run fixtures:import:nltk

      - name: Install browser engines
        run: bunx playwright install --with-deps chromium firefox

      - name: Build native + wasm + prebuilt
        run: |
          bun run build:zig
          bun run build:wasm
          bun run build:prebuilt

      - name: Verify npm package payload
        run: bun run pack:verify:prebuilt

      - name: Check wasm size budget
        run: bun run wasm:size:check

      - name: Run tests
        run: bun test

      - name: Generate parity report artifact
        run: bun run parity:report

      - name: Generate parity tracker artifact
        run: bun run parity:tracker

      - name: Run global Python parity suite
        run: bun run bench:parity:all

      - name: Run performance regression gate
        run: bun run bench:gate

      - name: Pack official WordNet corpus artifact
        run: |
          bun run wordnet:pack:official
          bun run wordnet:verify:pack

      - name: Generate bench dashboard artifacts
        run: bun run bench:dashboard

      - name: Run benchmark trend check
        run: bun run bench:trend:check

      - name: Run browser wasm benchmark
        run: bun run bench:browser:wasm

      - name: Upload bench dashboard
        uses: actions/upload-artifact@v4
        with:
          name: bench-dashboard
          path: artifacts/bench-dashboard.*

      - name: Upload browser wasm benchmark
        uses: actions/upload-artifact@v4
        with:
          name: browser-wasm-bench
          path: artifacts/browser-wasm-bench.*

      - name: Upload bench trend check
        uses: actions/upload-artifact@v4
        with:
          name: bench-trend-check
          path: artifacts/bench-trend-check.json

      - name: Upload parity report
        uses: actions/upload-artifact@v4
        with:
          name: parity-report
          path: artifacts/parity-report.*

      - name: Upload parity tracker
        uses: actions/upload-artifact@v4
        with:
          name: parity-tracker
          path: artifacts/parity-tracker.*

      - name: Upload official wordnet pack artifact
        uses: actions/upload-artifact@v4
        with:
          name: wordnet-official-pack
          path: |
            artifacts/wordnet_official.bin
            artifacts/wordnet_official.sha256.json

      - name: Upload imported NLTK fixtures
        uses: actions/upload-artifact@v4
        with:
          name: nltk-imported-fixtures
          path: test/fixtures/nltk_imported/*.json
